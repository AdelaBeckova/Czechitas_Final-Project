import csv
import json
import datetime
import boto3
import os

key_words_count={}

book_id_to_work_id={"1517589": "3204327", "17908001": "3204327", "821432": "1540236", "23308923": "3204327", "18755813": "1540236", "16132870": "1540236", "2945932": "3462456", "25606930": "2964424", "12973648": "1540236", "7112457": "2964424", "3379781": "2964424", "19590169": "1540236", "1451516": "3204327", "10094399": "1540236", "5898": "3462456", "59315": "2963845", "13511174": "1540236", "2151356": "2963845", "1220578": "3204327", "222909": "3204327", "6377868": "2964424", "20685983": "3204327", "1223951": "2963845", "25655344": "2964424", "54707": "3462456", "10333614": "1540236", "899802": "3462456", "5134220": "3204327", "18510": "3204327", "7362721": "3462456", "13309333": "2964424", "18779161": "1540236", "10228750": "3462456", "5808137": "2963845", "18693089": "1540236", "569465": "3462456", "349252": "3462456", "27801404": "1540236", "23432887": "1540236", "1463142": "2963845", "10802717": "3462456", "15923725": "1540236", "15923724": "1540236", "2193552": "1540236", "23573378": "1540236", "1395842": "2964424", "6495082": "1540236", "289915": "1540236", "289916": "1540236", "289919": "1540236", "5941419": "3204327", "13309276": "3204327", "22240815": "2963845", "13309296": "2963845", "35354979": "3462456", "289870": "1540236", "892586": "2963845", "7284788": "3204327", "1334396": "3204327", "838729": "2964424", "6428447": "2963845", "6428446": "3204327", "6428445": "1540236", "6428448": "2964424", "16176371": "1540236", "13417231": "1540236", "10125754": "1540236", "416454": "1540236", "16142669": "2964424", "15923738": "3204327", "13644671": "1540236", "360973": "3204327", "360974": "3462456", "1164368": "3204327", "1259829": "3462456", "22704939": "2963845", "24901856": "3462456", "1778426": "2964424", "18217505": "1540236", "5913": "1540236", "16170191": "1540236", "16168731": "1540236", "899715": "1540236", "15280": "2963845", "128681": "3204327", "289893": "1540236", "16694": "2963845", "34971628": "1540236", "11047557": "3462456", "6413483": "3462456", "6446128": "1540236", "20310621": "2963845", "1289973": "1540236", "1289974": "1540236", "16096472": "2964424", "16207338": "1540236", "1410734": "2964424", "10331216": "3462456", "27881740": "1540236", "13309386": "1540236", "70991": "3204327", "23485964": "2964424", "13432179": "3204327", "19006338": "1540236", "5660655": "2963845", "9683521": "1540236", 
"16131802": "1540236", "1436636": "1540236", "1436639": "1540236", "20820192": "2963845", "92660": "3204327", "899735": "2963845", "1811092": "2963845", "13429654": "1540236", "13513038": "3204327", "17157903": "2963845", "17157907": "2964424", "13556495": "2964424", "838626": "3204327", "8536478": "3204327", "7593357": "2963845", "21965598": "3204327", "9482762": "2963845", "16194782": "1540236", "6472585": "1540236", "17281652": "1540236", "15241": "2963845", "15245": "2964424", "6089561": "1540236", "21416335": "1540236", "10890461": "1540236", "2905845": "3204327", "13409834": "3204327", "727800": "2963845", "1259841": "1540236", "18936837": "1540236", "13603071": "1540236", "984745": "2964424", "16139801": "1540236", "899781": "3462456", "516989": "3462456", "15849342": "1540236", "1508208": "3462456", "21808520": "1540236", "1642721": "2964424", "883953": "2963845", "883952": "2964424", "13453387": "2963845", "16137394": "1540236", "2194861": "1540236", "1344101": "1540236", "2075778": "1540236", "2075441": "2964424", "2075445": "2964424", "2075447": "2964424", "25229887": "3204327", "3031667": "2963845", "4506507": "2964424", "2745011": "3462456", "25162993": "1540236", "17729062": "1540236", "26105150": "3462456", 
"1425869": "1540236", "7349": "3462456", "23778362": "3204327", "20510309": "1540236", "9691694": "1540236", "6225543": "1540236", "227232": "3204327", "227233": "3204327", "6288724": "1540236", "13513718": "1540236", "20821668": "2963845", "19523099": "1540236", "12416368": 
"1540236", "16168196": "3204327", "9079606": "3204327", "6071618": "2963845", "17912237": "1540236", "13227120": "3462456", "10333227": "1540236", "23432814": "3204327", "23432767": "2964424", "2903821": "2963845", "11963975": "1540236", "63389": "3204327", "163556": "2963845", "15860518": "1540236", "929675": "3204327", "19739376": "1540236", "838652": "1540236", "15834809": "2963845", "877732": "3462456", "877731": "2964424", "24071463": "1540236", "6645440": "1540236", "17057897": "1540236", "12223437": "1540236", "514236": "2964424", "23340895": "2964424", "1092793": "2963845", "1092794": "2963845", "1070463": "3204327", "17189927": "2963845", "17163398": "1540236", "10351083": "1540236", "11186750": "2964424", "13414569": "1540236", "569712": "2963845", "28092704": "3204327", "20321889": "1540236", "16133733": "1540236", "33239423": "3204327", "33648897": "2964424", "8581284": "3462456", "74366": "1540236", "74369": "1540236", "6125279": "1540236", "15846720": "1540236", "18217604": "2964424", "822620": "3204327", "9266146": "1540236", "340381": "3462456", "59304": "1540236", "59300": "1540236", "20316845": "2964424", "22591110": "1540236", "42672": "1540236", "222910": "2963845", "136773": "3204327", "257885": "1540236", "6536598": "3462456", "1490467": "2964424", "23249187": "2963845", "15699488": "3204327", "8167434": "3462456", "3009623": "2963845", "111782": "1540236", "20685999": "2963845", "10384008": "1540236", "6383251": "3204327", "15395": "3204327", "9678418": "3204327", "23777989": "1540236", "13496288": "1540236", "13453396": "2964424", "11529608": "1540236", "13604689": "3204327", "18048398": "2963845", "1642730": "2963845", "34235125": "1540236", "28385042": "1540236", "20804892": "3204327", "16101480": "1540236", "17375700": "3204327", "17257422": "1540236", "11846672": "3204327", "15997579": "2963845", "15997578": "2963845", "11520555": "3462456", "899773": "3462456", "899777": "3204327", "899774": "3204327", "899778": "2963845", "17257525": "1540236", "19295165": "1540236", "21969382": "1540236", "15998700": "2964424", "1110276": "2963845", "2795109": "1540236", "289926": "1540236", "13356705": "1540236", "13356707": "2963845", "13356706": "3204327", "827763": "3462456", "827764": "3462456", "7284792": "3462456", "21954891": "1540236", "437049": "1540236", "13595486": "1540236", "20980629": "1540236", "2502066": "1540236", "6415068": "1540236", "877730": "3204327", "18086783": "1540236", "5900": "3462456", "5907": "1540236", "5908": "1540236", "5909": "1540236", "16093991": "1540236", "16135209": "1540236", "15298": "2964424", "18131492": "1540236", "604516": "1540236", "5280632": "1540236", "15997537": "3204327", "15997536": "3204327", "899734": "2963845", "13488309": "2963845", "13488305": "3204327", "984744": "2963845", "6310025": "2963845", "6431861": "3462456", "2106414": "1540236", "18953701": "3462456", "13573878": "2964424", "10358217": "2964424", "10241797": "2964424", "19319788": "1540236", "892555": "2964424", "11385538": "3204327", "16167858": "1540236", "3185334": "1540236", "9874036": "3204327", "3140936": "1540236", "9539580": "2964424", "30704280": "3204327", "11503059": "3204327", "6703479": "3462456", "16138884": "2964424", "1612852": "3204327", "17314847": "3462456", "899694": "1540236", "12757148": "3204327", 
"15699438": "1540236", "727810": "2964424", "13103907": "3204327", "24909257": "2964424", "516970": "3462456", "2287224": "2963845", "2287223": "2963845", "6100392": "1540236", "2170094": "1540236", "1245620": "2963845", "1092790": "2963845", "165488": "3204327", "6637795": "1540236", "2286921": "1540236", "15896193": "3462456", "18078305": "1540236", "18937286": "1540236", "6468453": "1540236", "9501471": "2963845", "7634119": "2963845", "6124600": "3462456", "2978833": "1540236", "706457": "3462456", "349248": "1540236", "227221": "1540236", "227220": "1540236", "2272297": "1540236", "23510433": "1540236", "17225110": "3204327", "10358170": "3204327", "20821658": "3204327", "28797838": "1540236", "29559316": "1540236", "9821186": "3204327", "6926618": "3204327", "7745434": "2963845", "12250778": "2963845", "7862152": "3462456", "1245626": "2964424", "601135": "2963845", "49891": "2964424", "205999": "1540236", "23432822": "1540236", "35346101": "3204327", "13643755": "3462456", "9865829": "1540236", "6703351": "1540236", "63390": "3204327", "30282872": "1540236", "7749091": "1540236", 
"6215547": "2963845", "77683": "3204327", "13729429": "3462456", "15774338": "1540236", "6320187": "2964424", "6092518": "2964424", "222947": "3204327", "21600937": "1540236", "20490048": "3204327", "24819247": "2963845", "16699844": "1540236", "3386370": "1540236", "13510444": "3462456", "21479014": "1540236", "28419307": "2963845", "23637661": "2963845", "481774": "3204327", "17998136": "2964424", "24845016": "1540236", "6056694": "2964424", "6377832": "3204327", "13568210": "1540236", "16301363": "1540236", "24897072": "3204327", "837611": "1540236", "26125178": "1540236", "1392016": "2963845", "23653": "1540236", "74377": "1540236", "4722059": "3462456", "11996612": "3204327", 
"28779829": "2964424", "16165239": "2964424", "2386251": "1540236", "15809993": "1540236", "15330": "2964424", "12477414": "2964424", "13452388": "1540236", "24819182": "3204327", "63358": "2964424", "15923741": "2963845", "15923740": "2963845", "15923743": "2964424", "15923742": "2964424", "15923748": "1540236", "3263607": "3204327", "13452287": "1540236", "13592925": "1540236", "8692770": "1540236", "2751165": "3204327", "825248": "2963845", "12370887": "1540236", "17464890": "1540236", "20568627": "1540236", "3009630": "3204327", "20893054": "1540236", "289896": "1540236", "15729846": "2963845", "17194491": "3462456", "22586326": "3204327", "9156892": "3204327", "13456147": "1540236", "526423": "1540236", "7112456": "2963845", "2751131": "3204327", "12517169": "3204327", "17189957": "2964424", "4522630": "2963845", "17206477": "2964424", "2466202": "1540236", "201084": "3204327", "13171110": "2963845", "12422389": "1540236", "17833191": "2964424", "13497128": "3204327", "714059": "3204327", "8877901": "1540236", "33834285": "1540236", "24909293": "2963845", "1616729": "2964424", "24684502": "1540236", "7726831": "2963845", "215342": "3462456", "18375770": "1540236", "1395829": "3204327", "1490436": "1540236", "29959688": "3204327", "828398": "2963845", "8094590": "1540236", "18690544": "2963845", "623517": "2964424", "554286": "1540236", "17787995": "3462456", "1517598": "2963845", "25598388": "1540236", "9198609": "3462456", "17163376": "3204327", "20739094": "3204327", "5915": "1540236", 
"5910": "1540236", "5912": "1540236", "13410728": "2963845", "20859770": "1540236", "626106": "2963845", "9843706": "1540236", "630024": "2964424", "630023": "3204327", "13525796": "2963845", "9824236": "2964424", "15779810": "1540236", "17611510": "3204327", "2466204": "1540236", "20518287": "1540236", "9824733": "1540236", "273438": "3204327", "273437": "3462456", "17980859": "3462456", "3306187": "2963845", 
"17200661": "3462456", "17253881": "1540236", "222912": "2964424", "15838430": "3204327", "22717439": "1540236", "12622443": "1540236", "6421426": "1540236", "257880": "1540236", "1223937": "3204327", "166405": "2963845", "497349": "2964424", "497348": "2963845", "497347": "3204327", "21899285": "3204327", "12710530": "2963845", "16152266": "2964424", "16075298": "1540236", "9299528": "2964424", "13418167": "3204327", "1223939": "2964424", "1933444": "3204327", "7100699": "2963845", "17873474": "3204327", "17792137": "1540236", "10174603": "2964424", "10306534": "3462456", "16070445": "1540236", "15265": "3204327", "15269": "3204327", "15268": "2963845", "17252596": "3204327", "24334038": "1540236", "529015": "3462456", "6309474": "3204327", "394406": "1540236", "15815392": "1540236", "28667930": "1540236", "15748038": "1540236", "21784869": "2964424", "24750731": "1540236", "15282": "3204327", "601137": "2964424", "601134": "3204327", "12710825": "3204327", "1892746": "3204327", "24246344": "1540236", "16088284": "1540236", "19187583": "1540236", "14743516": "3204327", "1246552": "3204327", "1246553": "3204327", "1367355": "3204327", "2325009": "1540236", "18455330": "1540236", "838647": "1540236", "838641": "1540236", "838640": "1540236", "4506467": "3204327", "17206488": "2963845", "19277803": "2963845", "19277801": "2964424", "15757661": "3204327", "15729874": "2964424", "15710468": "3204327", "6051317": "1540236", "12082986": "1540236", "727798": "3204327", "23778204": "2963845", "5808073": "3204327", "12250760": "3204327", "884792": "3204327", "7031534": "2964424", "16076832": "2963845", "25935728": "1540236", "23432795": 
"2963845", "15853963": "3462456", "32051295": "3462456", "499550": "2963845", "11047558": "1540236", "3297831": "3204327", "3297830": "2963845", "20808730": "2964424", "31122025": "3462456", "7829280": "3462456", "16170202": "1540236", "3305515": "2963845", "17833185": "2963845", "13613180": "2964424", "423092": "3204327", "20579351": "3462456", "8072509": "1540236", "15719256": "1540236", "10704203": "1540236", "2888670": "2963845", "92671": "3204327", "165491": "2963845", "120752": "3462456", "15834687": "3204327", "1123741": "1540236", "18217498": "1540236", "3875037": "3204327", "30179042": "3204327", "54695": "2963845", "899801": "3462456", "21968641": "2964424", "822619": "3204327", "22474292": "1540236", "261857": "2964424", "6252072": "1540236", "1764278": "3204327", "13561533": "1540236", "15323": "3462456", "15329": "1540236", "16053513": "1540236", "4095589": "1540236", "2932941": "2963845", "25712098": "1540236", "2331": "3462456", "18691640": "1540236", "937196": "3204327", "2913945": "3204327", "8752913": "3462456", "2527331": "3462456", "8167707": "1540236", "15896190": "3462456", "20411193": "1540236", "2625026": "1540236", "2151424": "2964424", "25726700": "3204327", "10815422": "3462456", "1811091": "2964424", "17238735": "1540236", "17203078": "3204327", "6525843": "3204327", "20887536": "2963845", "6029307": "1540236", "18048390": "3204327", "2042557": "2964424", "2042556": "2963845", "16136307": "1540236", "17206506": "3204327", "6068617": "3204327", "22877681": "1540236", "19007288": "2964424", "28779815": "2963845", "714060": "1540236", "70533": "1540236", "21963585": "2963845", "12422721": "3204327", "12494017": "2963845", "899758": "2963845", "899759": "2964424", "899757": "2964424", "1395831": "2963845", "18518714": "1540236", "10387731": "1540236", "34678425": "3204327", "17158151": "1540236", "671212": "3462456", "3548172": "3204327", "34461051": "1540236", "11186745": "2963845", "11186746": "3204327", "9686355": "1540236", "1334340": "1540236", "22705024": "1540236", "11529526": "1540236", "1151447": "3204327", "9953869": "3462456", "176123": "2964424", "9714778": "3462456", "15777193": "1540236", "28455712": "3204327", "17257532": "3204327", "14635692": "1540236", "11375664": "3204327", "17237811": "3204327", "10455630": "2964424", "21965614": "2963845", "10358203": "2963845", "19215523": "3204327", "23562373": "1540236", "3875114": "2964424", "29934308": "3204327", "349246": "2963845", "828400": "2964424", "828401": "3204327", "20927204": "1540236", "19545425": "3462456", "13416638": "1540236", "11503096": "1540236", "16000285": "2964424", "16000284": "2963845", "16000283": "3204327", "16136714": "1540236", "15923739": "3204327", "15997556": "2964424", "15997552": "2964424", "899713": "1540236", "1070467": "2964424", "2751104": "2964424", "289906": "1540236", "12442430": "2963845", "12723153": "2963845", "227229": "1540236", "3874880": "2963845", "1432618": "3204327", "20333371": "3204327", "30646775": "1540236", "15998692": "2963845", "18512": "2964424", "18511": "2963845", "5153604": "3204327", "23944769": "1540236", "17183425": "1540236", "9637543": "2963845", "9637541": "2964424", "481779": "2963845", "16109434": "1540236", "16106079": "3204327", "22064967": "1540236", "20310019": "3204327", "4506493": "2963845", "24683657": "1540236", "7007112": "3204327", "13512170": "1540236", "24234652": "1540236", "10331142": "3462456", "6069923": "2964424", "1119641": "2963845", "9660616": "1540236", "33595507": "1540236", "11846692": "2964424", "1152666": "3204327", "136774": "3462456", "4584207": 
"1540236", "23778150": "2964424", "15397": "2964424", "20686069": "2964424", "17226375": "1540236", "28444285": "2964424", "12442478": "2964424", "8540726": "1540236", "14817508": "3462456", "20612721": "1540236", "1110277": "2964424", "3251912": "2963845", "4317823": "3462456", "12710382": "2964424", "13413709": "1540236", "29090265": "2964424", "4640383": "2964424", "12163200": "3204327", "795109": "3462456", "554211": "1540236", "16152251": "3204327", "16152256": "2963845", "24852340": "1540236", "3324528": "3462456", "27229138": "1540236", "1362027": "2964424", "838638": "1540236", "6500948": "2964424", "1233419": "2964424", "1233418": "2964424", "22053766": "1540236", "77685": "2964424", "77684": "2963845", "6377851": "2963845", "28137868": "3462456", "842491": "1540236", "18361455": "1540236", "15816110": "1540236", "2239767": "1540236", "2239768": "1540236", "12477399": "2963845", "899790": "2964424", "899795": "3204327", "15357": "3462456", "15354": "3462456", "15350": "3462456", "26098210": "1540236", "38": "3462456", "33": "3462456", "32": "3462456", "31": "3462456", "35": "3462456", "34": "3204327", "3782863": "3204327", "74375": "1540236", "28850": "2964424", "3297829": "2964424", "6620838": "3204327", "929711": "2963845", "26177340": "1540236", "13356708": "2964424", "7112087": "3204327", "18488199": "2963845", "7353": "3462456", "23211906": "3204327", "6508606": "1540236", "20342396": "1540236", "11836961": "3204327", "554256": "1540236", "11567852": "1540236", "6332181": "1540236", "12466252": "3204327", "13448328": "1540236", "10303734": "1540236", "7082578": "1540236", "9661681": "3462456", "16146461": "3462456", "1153955": "2963845", "18048405": "2964424", "20764074": "2963845", "6603019": "1540236", "10875128": "2964424", "16055384": "1540236", 
"19662370": "1540236", "822613": "3204327", "13497147": "2964424", "13328948": "3204327", "17261": "1540236", "15317": "3462456", "17237517": "1540236", "63378": "2963845", "21963487": "3204327", "16134225": "1540236", "15331": "3204327", "20820061": "3204327", "17885823": "1540236", "22704890": "3204327", "4526766": "2964424", "33802247": "1540236", "17696917": "1540236", "18130862": "1540236", "9414197": "3204327", "1811089": "2964424", "11332583": "3204327", "18687705": "2964424", "1079424": "2964424", "33234535": "1540236", "10369174": "3204327", "2751153": "2963845", "1811085": "3204327", "1811086": "3462456"}

book_names={"1540236":"Hobbit","3462456":"LOTR1-3","3204327":"LOTR1","2963845":"LOTR2","2964424":"LOTR3"}

comprehend = boto3.client('comprehend', region_name='eu-west-1', aws_access_key_id='XYZ', aws_secret_access_key='XYZ') #replaced access keys with 'XYZ' for publication purposes

with open('reviews_all_sentiment.csv',encoding='utf-8', mode="w") as out:
    with open('reviews_all_sentiment.json',encoding='utf-8', mode="w") as out_json:
        with open('reviews_all.json') as soubor:
            writer = csv.DictWriter(out, fieldnames=["book_id","review_id","date_added","date_updated","rating","review_text","n_votes","n_comments","user_id","date_added_iso","date_updated_iso","year","month","year_month","language","sentiment","key_phrases","work_id","work_name"], lineterminator="\n")
            writer.writeheader()
            i=0
            c=0
            for line in soubor:
                book = json.loads(line)
                dt_updated = datetime.datetime.strptime(book['date_updated'],'%a %b %d %H:%M:%S %z %Y')
                dt_added = datetime.datetime.strptime(book['date_added'],'%a %b %d %H:%M:%S %z %Y')
                if len(book["review_text"])==0:
                    continue #skočí na další cyklus
                #language
                if os.path.exists("data/language/language-"+book["review_id"]+".json"):
                    with open("data/language/language-"+book["review_id"]+".json",mode="rt") as json_file:
                        s=json_file.read()
                        response=json.loads(s)
                else:
                    response = comprehend.detect_dominant_language(Text=book['review_text'])
                    print(json.dumps(response), file=open('data/language/language-'+book['review_id']+'.json', 'w', encoding='utf8'))
                language = response['Languages'][0]['LanguageCode']
                #we detect reviews with more than 5000 characters
                if len(book["review_text"])>5000:
                    print(book["review_text"])
                    c+=1
                #sentiment
                if os.path.exists("data/sentiment/sentiment-"+book["review_id"]+".json"):
                    with open("data/sentiment/sentiment-"+book["review_id"]+".json",mode="rt") as json_file:
                        s=json_file.read()
                        response=json.loads(s)
                else:
                    if language in ["ar", "hi", "ko", "zh-TW", "ja", "zh", "de", "pt", "en", "it", "fr", "es"] and len(book["review_text"])<=5000:
                        response = comprehend.detect_sentiment(Text=book['review_text'],LanguageCode=language)
                        print(json.dumps(response), file=open('data/sentiment/sentiment-'+book['review_id']+'.json', 'w', encoding='utf8'))
                    else:
                        response={'Sentiment':'N/A'}
                sentiment = response['Sentiment']
                #detect key phrases
                if os.path.exists("data/key-phrases/key-phrases-"+book["review_id"]+".json"):
                    with open("data/key-phrases/key-phrases-"+book["review_id"]+".json",mode="rt") as json_file:
                        s=json_file.read()
                        response=json.loads(s)
                else:
                    if language in ["ar", "hi", "ko", "zh-TW", "ja", "zh", "de", "pt", "en", "it", "fr", "es"]:
                        response = comprehend.detect_key_phrases(Text=book['review_text'],LanguageCode=language)
                        print(json.dumps(response), file=open('data/key-phrases/key-phrases-'+book['review_id']+'.json', 'w', encoding='utf8'))
                    else:
                        response={'KeyPhrases':[]}
                key_phrases = []
                for key_phrase in response['KeyPhrases']:
                    if key_phrase['Text'].lower() not in key_phrases:
                        key_phrases.append(key_phrase['Text'].lower())
                    key=key_phrase['Text'].lower()
                    if key in key_words_count:
                        key_words_count[key]+=1
                    else:
                        key_words_count[key]=1
                key_phrases_text=json.dumps(key_phrases)

                #print(json.dumps(response))
                i+=1
                if i%100==0:
                    print(i)
                writer.writerow({
                    "book_id": book["book_id"],
                    "review_id": book["review_id"],
                    "date_added": book["date_added"],
                    "date_updated": book["date_updated"],
                    "rating": book["rating"],
                    "review_text": book["review_text"],
                    "n_votes": book["n_votes"],
                    "n_comments": book["n_comments"],
                    "user_id": book["user_id"],
                    "date_added_iso": dt_added.isoformat(),
                    "date_updated_iso": dt_updated.isoformat(),
                    "year":dt_added.year,
                    "month":dt_added.month,
                    "year_month":dt_added.astimezone(datetime.timezone.utc).strftime('%Y-%m'),
                    "language":language,
                    "sentiment":sentiment,
                    "key_phrases":key_phrases_text,
                    "work_id":book_id_to_work_id[book["book_id"]],
                    "work_name":book_names[book_id_to_work_id[book["book_id"]]]
                })
                book["date_added_iso"]=dt_added.isoformat()
                book["date_updated_iso"]=dt_updated.isoformat(),
                book["year"]=dt_added.year,
                book["month"]=dt_added.month,
                book["year_month"]=dt_added.astimezone(datetime.timezone.utc).strftime('%Y-%m'),
                book["language"]=language,
                book["sentiment"]=sentiment,
                book["key_phrases"]=key_phrases,
                book["work_id"]=book_id_to_work_id[book["book_id"]],
                book["work_name"]=book_names[book_id_to_work_id[book["book_id"]]]
                out_json.write(json.dumps(book)+"\n")
            print(c)
            print(json.dumps(key_words_count), file=open('key_words_count.json', 'w', encoding='utf8'))
